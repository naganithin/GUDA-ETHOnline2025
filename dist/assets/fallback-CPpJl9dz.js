import{n as C,b8 as q,bf as E,az as j,d6 as v}from"./index-DdPqfeSd.js";function S(n,g={}){const{key:b="fallback",name:h="Fallback",rank:f=!1,shouldThrow:k=D,retryCount:m,retryDelay:T}=g;return({chain:i,pollingInterval:_=4e3,timeout:o,...w})=>{let c=n,d=()=>{};const R=C({key:b,name:h,async request({method:t,params:e}){let l;const p=async(a=0)=>{const u=c[a]({...w,chain:i,retryCount:0,timeout:o});try{const s=await u.request({method:t,params:e});return d({method:t,params:e,response:s,transport:u,status:"success"}),s}catch(s){if(d({error:s,method:t,params:e,transport:u,status:"error"}),k(s)||a===c.length-1||(l??(l=c.slice(a+1).some(r=>{const{include:y,exclude:x}=r({chain:i}).config.methods||{};return y?y.includes(t):x?!x.includes(t):!0})),!l))throw s;return p(a+1)}};return p()},retryCount:m,retryDelay:T,type:"fallback"},{onResponse:t=>d=t,transports:c.map(t=>t({chain:i,retryCount:0}))});if(f){const t=typeof f=="object"?f:{};L({chain:i,interval:t.interval??_,onTransports:e=>c=e,ping:t.ping,sampleCount:t.sampleCount,timeout:t.timeout,transports:c,weights:t.weights})}return R}}function D(n){return!!("code"in n&&typeof n.code=="number"&&(n.code===q.code||n.code===E.code||j.nodeMessage.test(n.message)||n.code===5e3))}function L({chain:n,interval:g=4e3,onTransports:b,ping:h,sampleCount:f=10,timeout:k=1e3,transports:m,weights:T={}}){const{stability:i=.7,latency:_=.3}=T,o=[],w=async()=>{const c=await Promise.all(m.map(async t=>{const e=t({chain:n,retryCount:0,timeout:k}),l=Date.now();let p,a;try{await(h?h({transport:e}):e.request({method:"net_listening"})),a=1}catch{a=0}finally{p=Date.now()}return{latency:p-l,success:a}}));o.push(c),o.length>f&&o.shift();const d=Math.max(...o.map(t=>Math.max(...t.map(({latency:e})=>e)))),R=m.map((t,e)=>{const l=o.map(r=>r[e].latency),a=1-l.reduce((r,y)=>r+y,0)/l.length/d,u=o.map(r=>r[e].success),s=u.reduce((r,y)=>r+y,0)/u.length;return s===0?[0,e]:[_*a+i*s,e]}).sort((t,e)=>e[0]-t[0]);b(R.map(([,t])=>m[t])),await v(g),w()};w()}export{S as f,D as s};
